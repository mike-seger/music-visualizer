<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Preset Preview</title>
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
body {
  background: #111; color: #ccc;
  font-family: system-ui, -apple-system, sans-serif;
  font-size: 12px;
  padding: 48px 10px 40px;
}

/* ── Floating toolbar ── */
#toolbar {
  position: fixed; top: 0; left: 0; right: 0; z-index: 100;
  background: rgba(17,17,17,.92); backdrop-filter: blur(6px);
  border-bottom: 1px solid #2a2a2a;
  display: flex; align-items: center;
  padding: 8px 12px; gap: 10px;
}
#title { color: #888; flex: 1; }
#copy-btn {
  background: #222; border: 1px solid #444; color: #ddd;
  padding: 5px 14px; border-radius: 4px; font-size: 12px; cursor: pointer;
  white-space: nowrap;
}
#copy-btn:hover { background: #2e2e2e; }
#copy-btn .count { color: #fa4; }
#zip-btn {
  background: #222; border: 1px solid #444; color: #ddd;
  padding: 5px 14px; border-radius: 4px; font-size: 12px; cursor: pointer;
  white-space: nowrap;
}
#zip-btn:hover { background: #2e2e2e; }

/* ── Status bar ── */
#status-bar {
  position: fixed; top: 41px; left: 0; right: 0; z-index: 99;
  background: #1a1a2e; border-bottom: 1px solid #2a2a4a;
  padding: 5px 12px;
  font-size: 11px; color: #89a; letter-spacing: .02em;
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  display: none;
}
#status-bar.visible { display: block; }
body.has-status { padding-top: 68px; }

/* ── Group sections ── */
.group-section { margin-bottom: 20px; }
.group-header {
  display: flex; align-items: center; gap: 8px;
  margin-bottom: 8px;
}
.group-label {
  white-space: nowrap; color: #999;
  font-size: 11px; text-transform: uppercase; letter-spacing: .07em;
}
.group-count { color: #555; font-size: 11px; }
.group-line { flex: 1; height: 1px; background: #2a2a2a; }

/* ── Grid ── */
.grid { display: flex; flex-wrap: wrap; gap: 3px; }

/* ── Tile ── */
.tile {
  position: relative;
  width: var(--tile-w, 160px); height: var(--tile-h, 160px);
  flex-shrink: 0;
  background: #111;
  border-radius: 2px; overflow: hidden;
  outline: 2px solid transparent; outline-offset: 0;
  cursor: pointer;
}
.tile img {
  width: 100%; height: 100%;
  object-fit: contain;
  display: block;
}
.tile:hover { outline-color: #48c; }
.tile.selected { outline-color: #fa4; }
.tile.active { outline-color: #44ff9a; }
.tile.active.selected { outline-color: #fa4; }

/* Checkbox — hidden until hover, 50% opacity on hover, 80% when checked */
.tile-cb {
  position: absolute; bottom: 5px; right: 5px;
  width: 15px; height: 15px;
  cursor: pointer; accent-color: #fa4;
  opacity: 0;
  transition: opacity 0.1s;
}
.tile:hover .tile-cb { opacity: 0.5; }
.tile.selected .tile-cb { opacity: 0.8; }

/* ── Overlay (file:// fallback) ── */
#overlay {
  display: none; position: fixed; inset: 0; z-index: 200;
  background: rgba(0,0,0,.88);
  justify-content: center; align-items: center;
  cursor: pointer;
}
#overlay.open { display: flex; }
#overlay-img {
  max-width: 94vw; max-height: 94vh;
  object-fit: contain; border-radius: 3px;
  cursor: default;
}
#overlay-label {
  position: absolute; bottom: 12px; left: 50%;
  transform: translateX(-50%);
  background: rgba(0,0,0,.75); color: #eee;
  padding: 4px 12px; border-radius: 3px;
  font-size: 12px; white-space: nowrap; pointer-events: none;
}
</style>
</head>
<body>

<div id="toolbar">
  <span id="title">Preset Preview</span>
  <button id="zip-btn">Download ZIP</button>
  <button id="copy-btn">Copy selected as JSON (<span class="count" id="copy-count">0</span>)</button>
</div>

<div id="status-bar"></div>

<div id="root"><p style="color:#555;padding:20px">Waiting for data…</p></div>

<div id="overlay">
  <img id="overlay-img" src="" alt="">
  <div id="overlay-label"></div>
</div>

<script>
(function () {
  var IS_FILE = location.protocol === 'file:'
  var ch
  try { ch = new BroadcastChannel('visualizer-controls') } catch (e) { ch = null }

  // ── Notify main app we are ready (via BroadcastChannel) ──
  if (ch) ch.postMessage({ type: 'preview-ready' })

  var statusBar = document.getElementById('status-bar')
  var tilesByName = Object.create(null) // presetName → tile element
  var activeName = ''
  var selected = new Set()  // persists across re-renders; reset when group changes

  function setStatus(text) {
    if (!text) {
      statusBar.classList.remove('visible')
      document.body.classList.remove('has-status')
    } else {
      statusBar.textContent = text
      statusBar.classList.add('visible')
      document.body.classList.add('has-status')
    }
  }

  function setActive(name) {
    if (activeName && tilesByName[activeName]) tilesByName[activeName].classList.remove('active')
    activeName = name || ''
    if (activeName && tilesByName[activeName]) tilesByName[activeName].classList.add('active')
  }

  // ── Copy selected ── (wired once; `selected` is module-level)
  var copyCountEl = document.getElementById('copy-count')
  function updateCount() { copyCountEl.textContent = selected.size }
  document.getElementById('copy-btn').addEventListener('click', function () {
    var arr = Array.from(selected).sort()
    var text = JSON.stringify(arr, null, 2)
    if (navigator.clipboard && navigator.clipboard.writeText) {
      navigator.clipboard.writeText(text).catch(function () { fallbackCopy(text) })
    } else {
      fallbackCopy(text)
    }
  })

  // ── Receive messages via BroadcastChannel ──
  if (ch) ch.addEventListener('message', function (e) {
    if (!e.data) return
    if (e.data.type === 'preview-status') {
      setStatus(e.data.text || '')
      return
    }
    if (e.data.type === 'preview-data') {
      setStatus('')
      // Reset selection when a new group's data arrives
      selected.clear()
      updateCount()
      render(e.data.items, e.data.activePreset || '')
      return
    }
    if (e.data.type === 'visualizer-changed' && e.data.name) {
      setActive(e.data.name)
    }
  })

  // ── ZIP button ──
  document.getElementById('zip-btn').addEventListener('click', function () {
    if (ch) ch.postMessage({ type: 'preview-zip' })
  })

  // ── Render ──
  function render(items, activePreset) {
    tilesByName = Object.create(null)
    activeName = ''
    // Detect aspect ratio from the first image and size all tiles to fit
    if (items.length > 0) {
      var probe = new Image()
      probe.onload = function () {
        var scale = Math.min(160 / probe.naturalWidth, 160 / probe.naturalHeight)
        var tw = Math.round(probe.naturalWidth  * scale)
        var th = Math.round(probe.naturalHeight * scale)
        document.documentElement.style.setProperty('--tile-w', tw + 'px')
        document.documentElement.style.setProperty('--tile-h', th + 'px')
      }
      probe.src = items[0].blobUrl
    }

    var root = document.getElementById('root')
    var titleEl = document.getElementById('title')
    root.innerHTML = ''
    titleEl.textContent = items.length + ' Presets'

    // All items are for the same group — render flat grid, no group header needed
    var grid = document.createElement('div')
    grid.className = 'grid'
    for (var i = 0; i < items.length; i++) {
      grid.appendChild(makeTile(items[i]))
    }
    root.appendChild(grid)

    // Mark the active preset after all tiles are in the DOM
    if (activePreset) setActive(activePreset)
  }

  function makeTile(item) {
    var overlay = document.getElementById('overlay')
    var overlayImg = document.getElementById('overlay-img')
    var overlayLbl = document.getElementById('overlay-label')

    var tile = document.createElement('div')
    tile.className = 'tile'
    tile.title = item.presetName
    tilesByName[item.presetName] = tile

    var img = document.createElement('img')
    img.src = item.blobUrl
    img.alt = item.presetName
    img.loading = 'lazy'
    img.draggable = false

    var cb = document.createElement('input')
    cb.type = 'checkbox'
    cb.className = 'tile-cb'

    cb.addEventListener('change', function (e) {
      e.stopPropagation()
      if (cb.checked) { selected.add(item.jsonPath); tile.classList.add('selected') }
      else            { selected.delete(item.jsonPath); tile.classList.remove('selected') }
      updateCount()
    })
    cb.addEventListener('click', function (e) { e.stopPropagation() })

    tile.addEventListener('click', function () {
      if (IS_FILE) {
        // File-system fallback: lightbox
        overlayImg.src = item.blobUrl
        overlayLbl.textContent = item.presetName
        overlay.classList.add('open')
      } else {
        // Live server: switch preset in main app via BroadcastChannel
        if (ch) ch.postMessage({ type: 'select-visualizer', name: item.presetName })
      }
    })

    tile.appendChild(img)
    tile.appendChild(cb)
    return tile
  }

  // ── Overlay (file:// only) ──
  var overlay = document.getElementById('overlay')
  overlay.addEventListener('click', function (e) {
    if (e.target !== document.getElementById('overlay-img')) overlay.classList.remove('open')
  })
  document.addEventListener('keydown', function (e) {
    if (e.key === 'Escape') overlay.classList.remove('open')
  })

  function fallbackCopy(text) {
    var ta = document.createElement('textarea')
    ta.value = text
    ta.style.cssText = 'position:fixed;left:-9999px;top:-9999px'
    document.body.appendChild(ta); ta.select()
    try { document.execCommand('copy') } catch (e) {}
    document.body.removeChild(ta)
  }

  function esc(s) {
    return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
  }
})()
</script>
</body>
</html>
